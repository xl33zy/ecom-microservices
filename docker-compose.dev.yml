services:
  postgres:
    container_name: postgres_container
    image: postgres:14
    platform: linux/amd64
    environment:
      POSTGRES_USER: xl33zy
      POSTGRES_PASSWORD: xl33zy
      POSTGRES_DB: ecommerce
      PGDATA: /data/postgres
    volumes:
      - postgres:/data/postgres
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "5432:5432"
    networks: [backend]
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U xl33zy"]
      interval: 5s
      timeout: 5s
      retries: 5

  pgadmin:
    container_name: pgadmin_container
    image: dpage/pgadmin4
    platform: linux/amd64
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_DEFAULT_EMAIL:-pgadmin4@gpadmin.org}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_DEFAULT_PASSWORD:-admin}
      PGADMIN_CONFIG_SERVER_MODE: "False"
    volumes:
      - pgadmin:/var/lib/pgadmin
    ports:
      - "5050:80"
    depends_on:
      postgres:
        condition: service_healthy
    networks: [backend]
    restart: unless-stopped

  redis:
    container_name: redis
    image: redis:latest
    platform: linux/amd64
    ports:
      - "6379:6379"
    networks: [backend]
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5

  zookeeper:
    container_name: zookeeper
    image: confluentinc/cp-zookeeper:7.5.0
    platform: linux/amd64
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
    ports:
      - "2181:2181"
    networks: [backend]
    restart: unless-stopped

  kafka:
    container_name: kafka
    image: confluentinc/cp-kafka:7.5.0
    platform: linux/amd64
    depends_on:
      zookeeper:
        condition: service_started
    ports:
      - "29092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
    networks: [backend]
    restart: unless-stopped

  rabbitmq:
    container_name: rabbitmq
    image: rabbitmq:3-management
    platform: linux/amd64
    ports:
      - "5672:5672"
      - "15672:15672"
    networks: [backend]
    restart: unless-stopped
    healthcheck:
      # Заменили на более надежную проверку порта
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 20s

  keycloak:
    container_name: keycloak
    image: keycloak/keycloak:26.4.7
    platform: linux/amd64
    command: start-dev
    environment:
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
    ports:
      - "8443:8080"
    networks: [backend]
    restart: unless-stopped

  zipkin:
    container_name: zipkin
    image: openzipkin/zipkin:latest
    platform: linux/amd64
    ports:
      - "9411:9411"
    networks: [backend]
    restart: unless-stopped

  configserver:
    container_name: configserver
    image: ecom-configserver:0.0.1-SNAPSHOT
    platform: linux/amd64
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    ports:
      - "8888:8888"
    networks: [backend]
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8888/actuator/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  eureka:
    container_name: eureka
    image: ecom-eureka:0.0.1-SNAPSHOT
    platform: linux/amd64
    depends_on:
      configserver:
        condition: service_healthy
    ports:
      - "8761:8761"
    networks: [backend]
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8761/actuator/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  user:
    container_name: user-service
    image: ecom-user-service:0.0.1-SNAPSHOT
    platform: linux/amd64
    environment:
      - SPRING_CONFIG_IMPORT=configserver:http://configserver:8888/
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka:8761/eureka/
    depends_on:
      configserver:
        condition: service_healthy
      eureka:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks: [backend]
    restart: unless-stopped

  product:
    container_name: product-service
    image: ecom-product-service:0.0.1-SNAPSHOT
    platform: linux/amd64
    environment:
      - SPRING_CONFIG_IMPORT=configserver:http://configserver:8888/
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka:8761/eureka/
    depends_on:
      configserver:
        condition: service_healthy
      eureka:
        condition: service_healthy
    networks: [backend]
    restart: unless-stopped

  order:
    container_name: order-service
    image: ecom-order-service:0.0.1-SNAPSHOT
    platform: linux/amd64
    environment:
      - SPRING_CONFIG_IMPORT=configserver:http://configserver:8888/
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka:8761/eureka/
    depends_on:
      kafka:
        condition: service_started
      eureka:
        condition: service_healthy
      configserver:
        condition: service_healthy
    networks: [backend]
    restart: unless-stopped

  notification:
    container_name: notification-service
    image: ecom-notification:0.0.1-SNAPSHOT
    platform: linux/amd64
    environment:
      - SPRING_CONFIG_IMPORT=configserver:http://configserver:8888/
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka:8761/eureka/
    depends_on:
      kafka:
        condition: service_started
      eureka:
        condition: service_healthy
      configserver:
        condition: service_healthy
    networks: [backend]
    restart: unless-stopped

  gateway:
    container_name: gateway-service
    image: ecom-gateway:0.0.1-SNAPSHOT
    platform: linux/amd64
    ports:
      - "8080:8080"
    environment:
      - SPRING_CONFIG_IMPORT=configserver:http://configserver:8888/
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka:8761/eureka/
    depends_on:
      order:
        condition: service_started
      product:
        condition: service_started
      user:
        condition: service_started
      notification:
        condition: service_started
      eureka:
        condition: service_healthy
      configserver:
        condition: service_healthy
    networks: [backend]
    restart: unless-stopped

networks:
  backend:
    driver: bridge

volumes:
  postgres:
  pgadmin: